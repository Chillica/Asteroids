<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Asteroids</title>
    <link rel="stylesheet" type="text/css" href="default.css" />
</head>

<body>
    <canvas id="canvas"></canvas>

    <!--<script>
        
        function concatJSON(arry) {
            var val = "";
            for (i = 0; i < this.arry.length; i++) {
                if (i == this.asteroids.length - 1)
                    val.concat(this.arry[i].json);
                else
                    val.concat(this.arry[i].json + ",");
            }
            return JSON.parse(val);
        }

        class Asteroid {
            constructor() {
                this.pos = new Point();
                this.pos = new Point();
                this.size = 0.0;
            }
            json() {
                return this.json = {
                    "pos": {
                        "x": this.pos.x,
                        "y": this.pos.y
                    },
                    "pos": {
                        "x": this.pos.x,
                        "y": this.pos.y
                    },
                    "size": this.size
                }
            }
        }

        class Bullet {
            constructor() {
                this.pos = new Point;
                this.pos = new Point;
                this.ttl = 0.0;
            }
            json() {
                return this.json = {
                    "pos": {
                        "x": this.pos.x,
                        "y": this.pos.y
                    },
                    "pos": {
                        "x": this.pos.x,
                        "y": this.pos.y
                    },
                    "ttl": this.ttl
                }
            }
        }

        class Command {
            constructor() {
                this.shoot = false;
                this.accel = false;
                this.right = false;
                this.left = false;
            }
        }

        class GameState {
            constructor() {
                this.myShip = new Ship("myShip");
                this.enemy = new Ship("enemy");
                this.bullets = [];
                this.asteroids = [];
            }

            get gamejson() {
                return json = {
                    this: myShip.json,
                    this: enemy.json,
                    "asteroids": [
                        concatJSON(this.asteroids)
                    ],
                    "bullets": [
                        concatJSON(this.bullets)
                    ]
                }
            }
            set enemyjson(val) {
                this.enemy.json = val;
            }
        }

    </script>-->
    <script>
        const FPS = 30; // frames per second
        const FRICTION = 0.7; // friction coefficient of space (0 = no friction, 1 = lots of friction)
        const SHIP_SIZE = 30; // ship height in pixels
        const SHIP_THRUST = 5; // acceleration of the ship in pixels per second per second
        const TURN_SPEED = 360; // turn speed in degrees per second

        const LASER_DIST = 0.6; // max distance laser can travel as fraction of screen width
        const LASER_EXPLODE_DUR = 0.1; // duration of the lasers' explosion in seconds
        const LASER_MAX = 10; // maximum number of lasers on screen at once
        const LASER_SPD = 500; // speed of lasers in pixels per second

        var canv = document.getElementById("canvas");
        var ctx = canv.getContext("2d");
        
        canv.height = window.innerHeight;
        canv.width = window.innerWidth;


        class Point {
            constructor() {
                this.x = 0.0;
                this.y = 0.0;
            }
        }

        class Ship {
            constructor(ship, color) {
                this.shipname = ship;
                this.pos = new Point;
                this.pos_delta = new Point;
                this.heading = 90 / 180 * Math.PI;
                this.radius = SHIP_SIZE / 2;
                this.rotation = 0;
                this.canShoot = true;
                this.lasers = [];
                this.thrusting = false;
                this.thrust = new Point;
                this.color = color;
                this.json = {};
            }
            drawShip() {
                if(this.color === undefined)
                    ctx.strokeStyle = "white";
                else
                    ctx.strokeStyle = this.color;
                ctx.lineWidth = SHIP_SIZE / 20;
                ctx.beginPath();
                ctx.moveTo (
                    this.pos.x + 4 / 3 * this.radius * Math.cos(this.heading),
                    this.pos.y - 4 / 3 * this.radius * Math.sin(this.heading)
                );
                ctx.lineTo (
                    this.pos.x - this.radius * (2 / 3 * Math.cos(this.heading) + Math.sin(this.heading)),
                    this.pos.y + this.radius * (2 / 3 * Math.sin(this.heading) - Math.cos(this.heading))
                );
                ctx.lineTo(
                    this.pos.x - this.radius * (2 / 3 * Math.cos(this.heading) - Math.sin(this.heading)),
                    this.pos.y + this.radius * (2 / 3 * Math.sin(this.heading) + Math.cos(this.heading))
                );
                ctx.closePath();
                ctx.stroke();
            }
            drawShipTail(){
                ctx.fillStyle = "red";
                ctx.strokeStyle = "yellow";
                ctx.lineWidth = SHIP_SIZE / 10;
                ctx.beginPath();
                ctx.moveTo(
                    this.pos.x - this.radius * (2/3 * Math.cos(this.heading) + 0.5 * Math.sin(this.heading)),
                    this.pos.y + this.radius * (2/3 * Math.sin(this.heading) - 0.5 * Math.cos(this.heading))
                );
                ctx.lineTo(
                    this.pos.x - this.radius * 5/3 * Math.cos(this.heading),
                    this.pos.y + this.radius * 5/3 * Math.sin(this.heading),
                );
                ctx.lineTo(
                    this.pos.x - this.radius * (2/3 * Math.cos(this.heading) - 0.5 * Math.sin(this.heading)),
                    this.pos.y + this.radius * (2/3 * Math.sin(this.heading) + 0.5 * Math.cos(this.heading))
                );
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            move() {
                if (this.thrusting) {
                    this.thrust.x += SHIP_THRUST * Math.cos(this.heading) / FPS;
                    this.thrust.y -= SHIP_THRUST * Math.sin(this.heading) / FPS;
                    this.drawShipTail();
                    
                } else {
                    this.thrust.x -= FRICTION * this.thrust.x / FPS;
                    this.thrust.y -= FRICTION * this.thrust.y / FPS;
                }
                this.drawShip();
                this.heading += this.rotation;
                this.pos.x += this.thrust.x;
                this.pos.y += this.thrust.y;

                if (this.pos.x < 0 - this.radius){
                    this.pos.x = canv.width + this.radius;
                } else if (this.pos.x > canv.width + this.radius) {
                    this.pos.x = 0 - this.radius;
                }

                if (this.pos.y < 0 - this.radius){
                    this.pos.y = canv.height + this.radius;
                } else if (this.pos.y > canv.height + this.radius) {
                    this.pos.y = 0 - this.radius;
                }
            }
            shootLaser() {
                // create the laser object
                if (this.canShoot && this.lasers.length < LASER_MAX) {
                    this.lasers.push({ // from the nose of the ship
                        x: this.pos.x + 4 / 3 * this.radius * Math.cos(this.heading),
                        y: this.pos.y - 4 / 3 * this.radius * Math.sin(this.heading),
                        xv: LASER_SPD * Math.cos(this.heading) / FPS,
                        yv: -LASER_SPD * Math.sin(this.heading) / FPS,
                        dist: 0,
                        explodeTime: 0
                    });
                }
                // prevent further shooting
                this.canShoot = false;
            }
            drawLaser() {
                // draw the lasers
                for (var i = 0; i < this.lasers.length; i++) {
                    if (this.lasers[i].explodeTime == 0) {
                        ctx.fillStyle = "salmon";
                        ctx.beginPath();
                        ctx.arc(this.lasers[i].x, this.lasers[i].y, SHIP_SIZE / 15, 0, Math.PI * 2, false);
                        ctx.fill();
                    } else {
                        // draw the eplosion
                        ctx.fillStyle = "orangered";
                        ctx.beginPath();
                        ctx.arc(this.lasers[i].x, this.lasers[i].y, this.radius * 0.75, 0, Math.PI * 2, false);
                        ctx.fill();
                        ctx.fillStyle = "salmon";
                        ctx.beginPath();
                        ctx.arc(this.lasers[i].x, this.lasers[i].y, this.radius * 0.5, 0, Math.PI * 2, false);
                        ctx.fill();
                        ctx.fillStyle = "pink";
                        ctx.beginPath();
                        ctx.arc(this.lasers[i].x, this.lasers[i].y, this.radius * 0.25, 0, Math.PI * 2, false);
                        ctx.fill();
                    }
                }
                // move the lasers
                for (var i = this.lasers.length - 1; i >= 0; i--) {
                    
                    // check distance travelled
                    if (this.lasers[i].dist > LASER_DIST * canv.width) {
                        this.lasers.splice(i, 1);
                        continue;
                    }

                    // handle the explosion
                    if (this.lasers[i].explodeTime > 0) {
                        this.lasers[i].explodeTime--;

                        // destroy the laser after the duration is up
                        if (this.lasers[i].explodeTime == 0) {
                            this.lasers.splice(i, 1);
                            continue;
                        }
                    } else {
                        // move the laser
                        this.lasers[i].x += this.lasers[i].xv;
                        this.lasers[i].y += this.lasers[i].yv;

                        // calculate the distance travelled
                        this.lasers[i].dist += Math.sqrt(Math.pow(this.lasers[i].xv, 2) + Math.pow(this.lasers[i].yv, 2));
                    }

                    // handle edge of screen
                    if (this.lasers[i].x < 0) {
                        this.lasers[i].x = canv.width;
                    } else if (this.lasers[i].x > canv.width) {
                        this.lasers[i].x = 0;
                    }
                    if (this.lasers[i].y < 0) {
                        this.lasers[i].y = canv.height;
                    } else if (this.lasers[i].y > canv.height) {
                        this.lasers[i].y = 0;
                    }
                }

            }
            json() {
                return json = {
                    "${this.shipname}": {
                        "pos": {
                            "x": this.pos.x,
                            "y": this.pos.y
                        },
                        "pos": {
                            "x": this.pos.x,
                            "y": this.pos.y
                        },
                        "heading": this.heading,
                        "accleration": this.acceleration
                    }
                };
            }
        }
        
        ship = new Ship("myShip");
        //ship2 = new Ship("enemyShip", "red");

        // set up event handlers
        document.addEventListener("keydown", keyDown);
        document.addEventListener("keyup", keyUp);
        
        window.addEventListener('resize', resizeCanvas, false);
        function resizeCanvas(){
            canv.height = window.innerHeight;
            canv.width = window.innerWidth;
        }

        // set up the game loop
        setInterval(update, 1000 / FPS);

        function keyDown(/** @type {KeyboardEvent} */ ev) {
            switch(ev.keyCode) {
                case 32: // space bar (shoot laser)
                    ship.shootLaser();
                    break;
                case 37: // left arrow (rotate ship left)
                    ship.rotation = TURN_SPEED / 180 * Math.PI / FPS;
                    break;
                case 38: // up arrow (thrust the ship forward)
                    ship.thrusting = true;
                    break;
                case 39: // right arrow (rotate ship right)
                    ship.rotation = -TURN_SPEED / 180 * Math.PI / FPS;
                    break;
                case 65:
                    ship2.rotation = TURN_SPEED / 180 * Math.PI / FPS;
                    break;
                case 87:
                    ship2.thrusting = true;
                    break;
                case 68:
                    ship2.rotation = -TURN_SPEED / 180 * Math.PI / FPS;
                    break;
            }
        }

        function keyUp(/** @type {KeyboardEvent} */ ev) {
            switch(ev.keyCode) {
                case 32: // space bar (allow shooting again)
                    ship.canShoot = true;
                    break;
                case 37: // left arrow (stop rotating left)
                    ship.rotation = 0;
                    break;
                case 38: // up arrow (stop thrusting)
                    ship.thrusting = false;
                    break;
                case 39: // right arrow (stop rotating right)
                    ship.rotation = 0;
                    break;
                case 65:
                    ship2.rotation = 0;
                    break;
                case 87:
                    ship2.thrusting = false;
                    break;
                case 68:
                    ship2.rotation = 0;
                    break;
            }
        }

        function update() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canv.width, canv.height);

            ship.move();
            //ship2.move();
            ship.drawLaser();
        }
    </script>
</body>

</html>